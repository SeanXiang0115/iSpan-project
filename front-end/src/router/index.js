import { createRouter, createWebHistory } from 'vue-router';



// 定義router
const routes = [
  {
    path: '/',
    name: 'Home',
    component: () => import('@/views/HomeView.vue'),
  },
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/views/LoginView.vue'),
  },
  {
    path: '/forgot-password',
    name: 'ForgetPassword',
    component: () => import('@/views/ForgetPasswordView.vue'),
    meta: { layout: 'blank' }
  },
  {
    path: '/reset-password',
    name: 'ResetPassword',
    component: () => import('@/views/ResetPasswordView.vue'),
    meta: { layout: 'blank' }
  },
  {
    path: '/userInfo',
    name: 'UserInfo',
    component: () => import('@/views/UserInfoView.vue'),
    meta: { requiresAuth: true },
    redirect: '/userInfo/profile', // Default redirect
    children: [
      {
        path: 'profile',
        name: 'UserProfile',
        component: () => import('@/views/UserInfoContent.vue'),
        props: { title: '個人資料' }
      },
      {
        path: 'bookings',
        name: 'UserBookingsTab',
        component: () => import('@/views/UserInfoContent.vue'),
        props: { title: '我的訂位' }
      },
      {
        path: 'orders',
        name: 'UserOrders',
        component: () => import('@/views/UserInfoContent.vue'),
        props: { title: '我的訂單' }
      },
      {
        path: 'store-registration', // Child path
        name: 'UserInfoStoreReg',
        component: () => import('@/views/UserInfoStoreReg.vue')
      }
    ]
  },
  {
    path: '/storeRegistration',
    name: 'StoreRegistration',
    component: () => import('@/views/StoreRegistrationView.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/shopStore',
    component: () => import('@/views/shopStore.vue'),
    name: 'ShopStore'
  },
  {
    path: '/Cart',
    component: () => import('@/views/shopCart.vue'),
    name: 'ShopCart'
  },
  {
    path: '/storeInfo',
    name: 'StoreInfo',
    component: () => import('@/views/StoreInfoView.vue'),
  },
  {
    path: '/storeInfo/reservation',
    name: 'Reservation',
    component: () => import('@/views/ReservationView.vue'),
  },
  {
    path: '/user/bookings',
    name: 'UserBookings',
    component: () => import('@/views/UserBookingsView.vue')
  },
  {
    path: '/owner/storeInfo',
    name: 'OwnerStoreInfo',
    component: () => import('@/views/OwnerProfileView.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/owner/bookings/seats',
    name: 'Seats',
    component: () => import('@/views/SeatsAndTimeView.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/owner/bookings/data',
    name: 'Data',
    component: () => import('@/views/BookingDataView.vue'),
    meta: { requiresAuth: true }
  },
  // {
  //   path: '/home',
  //   component: () => import('@/views/HomeView.vue'),
  //   name: 'Home'
  // },
  {
    path: '/about',
    component: () => import('@/views/AboutView.vue'),
    name: 'About'
  },
  {
    path: '/mapSearch',
    component: () => import('@/views/MapSearchView.vue'),
    name: 'MapSearch'
  },
  {
    path: '/feedback',
    component: () => import('@/views/FeedbackView.vue'),
    name: 'Feedback'
  },
  {
    path: '/feedbackAP',
    component: () => import('@/views/FeedbackAPView.vue'),
    name: 'FeedbackAP'
  },
  {
    path: '/oauth2/redirect',
    name: 'OAuth2Redirect',
    component: () => import('@/views/OAuth2RedirectHandler.vue'),
    meta: { layout: 'blank' }
  },
  {
    path: '/register',
    component: () => import('@/views/RegisterView.vue'),
    name: 'Register',
    meta: { layout: 'blank' }
  },
  {
    path: '/productsDetail/:id',
    component: () => import('@/views/productsDetail.vue'),
    name: 'productsDetail',
  },
  {
    path: '/checkOut',
    component: () => import('@/views/checkOut.vue'),
    name: 'checkOut',
  },
  // Admin Routes
  {
    path: '/admin',
    component: () => import('@/layouts/admin.vue'),
    meta: { requiresAdminAuth: true },
    children: [
      {
        path: '',
        name: 'AdminDashboard',
        component: () => import('@/views/ERPTransferView.vue')
      },
      {
        path: 'frontend/banners',
        name: 'AdminFrontendBanners',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'frontend/content',
        name: 'AdminFrontendContent',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'news/list',
        name: 'AdminNewsList',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'news/create',
        name: 'AdminNewsCreate',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'knowledge/list',
        name: 'AdminKnowledgeList',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'knowledge/categories',
        name: 'AdminKnowledgeCategories',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'products/list',
        name: 'AdminProductsList',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'products/create',
        name: 'AdminProductsCreate',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'products/categories',
        name: 'AdminProductsCategories',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'sales/orders',
        name: 'AdminSalesOrders',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'sales/reports',
        name: 'AdminSalesReports',
        component: () => import('@/views/AdminDashboard.vue') // placeholder
      },
      {
        path: 'users/list',
        name: 'AdminUsersList',
        component: () => import('@/views/UserListView.vue')
      },
      {
        path: 'users/storeRegistration',
        name: 'StoreRegistrationCheck',
        component: () => import('@/views/StoreRegistrationCheckView.vue')
      }
      ,
      {
        path: 'backEnd/productsList',
        name: 'BackEndProductsList',
        component: () => import('@/views/BackEndProductsList.vue')
      },
      {
        path: 'backEnd/productsOrders',
        name: 'BackEndproductsOrders',
        component: () => import('@/views/BackEndproductsOrders.vue')
      }, {
        path: '/feedbackAP',
        name: 'FeedbackAP',
        component: () => import('@/views/FeedbackAPView.vue') // placeholder
      },
      {
        path: 'admins/list',
        name: 'AdminsList',
        component: () => import('@/views/AdminListView.vue'), // placeholder
        // TODO: 測試完成後，移除此行恢復強制登入檢查
        meta: { requiresAdminAuth: false }
      }
    ]
  },
  {
    path: '/admin/login',
    name: 'AdminLogin',
    component: () => import('@/views/AdminLoginView.vue'),
    meta: { layout: 'blank' }
  },
  {
    path: '/getusertest',
    name: 'GetUserTest',
    component: () => import('@/views/GetUserTestView.vue')
  },
  {
    path: '/test',
    name: 'Test',
    component: () => import('@/views/TestView.vue')
  }

];

// 建立router
const router = createRouter({
  history: createWebHistory(),
  routes: routes,
  scrollBehavior(to, from, savedPosition) {
    // 始終滾動到頂部
    return { top: 0 }
  }
});



import { useAuthStore } from '@/stores/auth';
import { useAdminAuthStore } from '@/stores/adminAuth';
import Swal from 'sweetalert2';

// 路由守衛
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore();
  const adminAuthStore = useAdminAuthStore();

  if (to.meta.requiresAdminAuth) {
    // [直接檢查 Local Storage 的方式]
    // 說明：若希望連「手動刪除 Local Storage」時，也能在切換頁面瞬間立刻攔截，可取消以下註解
    // const localAdminToken = localStorage.getItem('adminAccessToken');
    // if (!localAdminToken) {
    //   await adminAuthStore.handleLogoutAndNotify('unauthorized');
    //   return next('/admin/login');
    // }

    // Check if token is expired, useAdminAuthStore.isExpired will be implemented next
    if (adminAuthStore.isExpired) {
      await adminAuthStore.handleLogoutAndNotify('timeout');
      return next('/admin/login');
    }

    if (!adminAuthStore.isLoggedIn) {
      await adminAuthStore.handleLogoutAndNotify('unauthorized');
      return next('/admin/login');
    }
  }

  if (to.meta.requiresAuth) {
    if (authStore.isExpired) {
      await authStore.handleLogoutAndNotify('timeout');
      return next('/login');
    }

    if (!authStore.isLoggedIn) {
      await authStore.handleLogoutAndNotify('unauthorized');
      return next('/login');
    }
  }
  next();
});

export default router;
